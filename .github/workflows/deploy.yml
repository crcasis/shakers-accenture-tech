name: Deploy Blue/Green s3 accenture

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

env:
  APP_NAME: s3-accenture
  BUCKET_BLUE: s3-accenture-blue
  BUCKET_GREEN: s3-accenture-green
  CONFIG_BUCKET: s3-accenture-config
  ACTIVE_ENV_KEY: dev.txt
  CLOUDFRONT_DIST_ID: E1234567

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/github-actions-deployer
          aws-region: us-east-1

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      # Determine Active Environment (Blue or Green)
      - name: Get active environment from S3
        id: active
        run: |
          aws s3 cp s3://$CONFIG_BUCKET/$ACTIVE_ENV_KEY active_env.txt
          ACTIVE=$(cat active_env.txt)
          echo "Active: $ACTIVE"
          if [ "$ACTIVE" = "blue" ]; then
            echo "target=green" >> $GITHUB_OUTPUT
            echo "target_bucket=$BUCKET_GREEN" >> $GITHUB_OUTPUT
            echo "rollback_bucket=$BUCKET_BLUE" >> $GITHUB_OUTPUT
          else
            echo "target=blue" >> $GITHUB_OUTPUT
            echo "target_bucket=$BUCKET_BLUE" >> $GITHUB_OUTPUT
            echo "rollback_bucket=$BUCKET_GREEN" >> $GITHUB_OUTPUT
          fi

      # Upload artifacts (safe upload: temp prefix then promote)
      - name: Upload to S3 temp prefix
        run: |
          aws s3 sync ./dist s3://${{ steps.active.outputs.target_bucket }}/tmp --delete

      - name: Promote temp prefix to root
        run: |
          aws s3 rm s3://${{ steps.active.outputs.target_bucket }}/ --recursive
          aws s3 sync s3://${{ steps.active.outputs.target_bucket }}/tmp s3://${{ steps.active.outputs.target_bucket }}/
          aws s3 rm s3://${{ steps.active.outputs.target_bucket }}/tmp --recursive

      # Smoke Test (simple availability test)
      - name: Perform smoke test
        id: smoketest
        run: |
          URL="https://${{ steps.active.outputs.target }}.example.com/index.html"
          echo "Testing $URL ..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" $URL)
          echo "Status: $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "Smoke test failed"
            exit 1
          fi

      # Swap Environment (update configuration bucket)
      - name: Update active environment
        run: |
          echo "${{ steps.active.outputs.target }}" > active_env.txt
          aws s3 cp active_env.txt s3://$CONFIG_BUCKET/$ACTIVE_ENV_KEY

      # CloudFront Cache Invalidation
      - name: Create CloudFront invalidation
        run: |
          aws cloudfront create-invalidation \
            --distribution-id $CLOUDFRONT_DIST_ID \
            --paths "/*"

      # Rollback on failure
      - name: Rollback if smoke test failed
        if: failure()
        run: |
          echo "Reverting active environment..."
          aws s3 cp s3://$CONFIG_BUCKET/$ACTIVE_ENV_KEY env_backup.txt
          echo "${{ steps.active.outputs.rollback_bucket }}" > active_env.txt
          aws s3 cp active_env.txt s3://$CONFIG_BUCKET/$ACTIVE_ENV_KEY
