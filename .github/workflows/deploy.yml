name: Deploy Blue/Green S3 Accenture

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

env:
  APP_NAME: ${{ secrets.APP_NAME }}
  BUCKET_BLUE: ${{ secrets.BUCKET_BLUE }}
  BUCKET_GREEN: ${{ secrets.BUCKET_GREEN }}
  CONFIG_BUCKET: ${{ secrets.CONFIG_BUCKET }}
  ACTIVE_ENV_KEY: ${{ secrets.ACTIVE_ENV_KEY }}
  CLOUDFRONT_DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Get active environment from S3
        id: active
        run: |
          aws s3 cp s3://$CONFIG_BUCKET/$ACTIVE_ENV_KEY active_env.txt
          ACTIVE=$(cat active_env.txt)
          echo "Active: $ACTIVE"
          if [ "$ACTIVE" = "blue" ]; then
            echo "target=green" >> $GITHUB_OUTPUT
            echo "target_bucket=$BUCKET_GREEN" >> $GITHUB_OUTPUT
            echo "rollback_bucket=$BUCKET_BLUE" >> $GITHUB_OUTPUT
          else
            echo "target=blue" >> $GITHUB_OUTPUT
            echo "target_bucket=$BUCKET_BLUE" >> $GITHUB_OUTPUT
            echo "rollback_bucket=$BUCKET_GREEN" >> $GITHUB_OUTPUT
          fi

      - name: Upload to S3 temp prefix
        run: |
          aws s3 sync ./dist s3://${{ steps.active.outputs.target_bucket }}/tmp --delete

      - name: Promote temp prefix to root
        run: |
          aws s3 sync s3://${{ steps.active.outputs.target_bucket }}/tmp s3://${{ steps.active.outputs.target_bucket }}/
          aws s3 rm s3://${{ steps.active.outputs.target_bucket }}/tmp --recursive

      - name: Perform smoke test
        id: smoketest
        run: |
          URL="https://${{ steps.active.outputs.target }}.example.com/index.html"
          echo "Testing $URL ..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" $URL)
          echo "Status: $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "Smoke test failed"
            exit 1
          fi

      - name: Update active environment
        run: |
          echo "${{ steps.active.outputs.target }}" > active_env.txt
          aws s3 cp active_env.txt s3://$CONFIG_BUCKET/$ACTIVE_ENV_KEY

      - name: Create CloudFront invalidation
        run: |
          aws cloudfront create-invalidation \
            --distribution-id $CLOUDFRONT_DIST_ID \
            --paths "/*"

    # Rollback automÃ¡tico si falla cualquier paso
      - name: Rollback if deploy failed
        if: failure()
        run: |
          echo "Rollback triggered..."
          echo "${{ steps.active.outputs.rollback_bucket }}" > active_env.txt
          aws s3 cp active_env.txt s3://$CONFIG_BUCKET/$ACTIVE_ENV_KEY

      - name: Notify Slack
        if: always()
        run: |
          STATUS="SUCCESS"
          if [ "${{ job.status }}" != "success" ]; then
            STATUS="FAILED"
          fi
          PAYLOAD="{\"text\": \"Deployment of $APP_NAME (${GITHUB_REF_NAME}) finished with status: $STATUS\"}"
          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" $SLACK_WEBHOOK
  